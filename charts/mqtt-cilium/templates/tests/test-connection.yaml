apiVersion: v1
kind: Pod
metadata:
  name: {{ include "mqtt-cilium.fullname" . }}-test-connection
  labels:
    {{- include "mqtt-cilium.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
    - name: mqtt-check
      image: "{{ .Values.mosquittoDeployment.image.repository }}:{{ .Values.mosquittoDeployment.image.tag }}"
      command:
        - sh
        - -c
        - |
          # We use the Service name and port 1883
          # Note: We assume 'admin' user for the test
          echo "Testing connection to {{ include "mqtt-cilium.fullname" . }}-lb..."
          mosquitto_pub -h {{ include "mqtt-cilium.fullname" . }}-lb \
            -p 1883 \
            -t "health/check" \
            -m "ping" \
            -u admin \
            -P "$MQTT_PASSWORD" \
            --id "helm-test-pod"
      env:
        - name: MQTT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ default (printf "%s-auth" (include "mqtt-cilium.fullname" .)) .Values.mosquittoSecrets.existingSecret }}
              key: password_file
  restartPolicy: Never